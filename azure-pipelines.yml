# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool: Default

steps: 
- task: octane-start-task@25
  inputs:
    OctaneServiceConnection: 'octaneConnectionUft'
    WorkspaceList: '4002'
    GithubRepositoryConnection: 'githubConnection'
    CreatePipelineCheckbox: true


- powershell: |
    Write-Host 'Looking for testsToRun in environment...'
    Write-Host "env:testsToRun = '$env:testsToRun'"
    Write-Host "env:TESTSTORUN = '$env:TESTSTORUN'"
    Write-Host 'Dumping any env vars that look related:'
    Get-ChildItem env: | Where-Object Name -match 'TESTS|OCTANE|RUN' | Sort-Object Name | Format-Table -AutoSize
  displayName: "Probe for testsToRun (env)"


- powershell: | 
   Write-Host "Current Directory:"
   Get-Location
   echo "Building..."
   mkdir build
   $ESCAPED_DIR = $Env:BUILD_SOURCESDIRECTORY.Replace('\', '\\')
   echo "These are the tests:"
   echo "Testst"
   $TESTS_TO_RUN_XML = $testsToRun -replace ('\\?FTToolsLauncher\\', '')
   Set-Content -Path ./build/testsToRun.mtbx -Value "$TESTS_TO_RUN_XML"
   Set-Content -Path ./build/testsToRun.mtbx -Value @'
   <mtbx>
   <test name="VerifyChromeBrowser" path="VerifyChromeBrowser">
    <parameter name="runId" value="5031" type="string"/>
   </test>
   <test name="VerifyEdgeBrowser" path="VerifyEdgeBrowser">
    <parameter name="runId" value="5030" type="string"/>
   </test>
   </mtbx>
   '@
   Set-Content -Path ./build/Props.txt -Value "runType=FileSystem"
   Add-Content -Path ./build/Props.txt -Value "resultsFilename=build\\Results.xml"
   Add-Content -Path ./build/Props.txt -Value "Test1=$ESCAPED_DIR\\browsers" 
   Add-Content -Path ./build/Props.txt -Value "resultUnifiedTestClassname=true"
   Add-Content -Path ./build/Props.txt -Value "resultTestNameOnly=true"
   Get-Content -Path ./build/Props.txt

- powershell: | 
    echo "Testing..."
    echo $PWD
    Test-Path "./build/Props.txt" -PathType leaf
    Get-Content -Path ./build/Props.txt
    Start-Process "FTToolsLauncher_net48.exe" -ArgumentList "-paramfile `"$(Get-Location)\build\Props.txt`"" -Wait
    echo "Please check the [$PWD\build\Results.xml] file."

- task: octane-end-task@25
  inputs:
    OctaneServiceConnection: 'octaneConnectionUft'
    WorkspaceList: '4002'
         



     
          
 